pour la gestion des utilisateurs par l'admin, avec pagination, filtres et statistiques.
sql-- ============================================================================
-- FONCTION: get_admin_all_utilisateurs()
-- Objectif: Liste complète des utilisateurs pour le dashboard admin
-- ============================================================================

CREATE OR REPLACE FUNCTION get_admin_all_utilisateurs(
    p_limit INTEGER DEFAULT 20,
    p_offset INTEGER DEFAULT 0,
    p_search VARCHAR DEFAULT NULL,
    p_id_structure INTEGER DEFAULT NULL,
    p_id_groupe INTEGER DEFAULT NULL,
    p_id_profil INTEGER DEFAULT NULL,
    p_actif BOOLEAN DEFAULT NULL,              -- NULL = tous, TRUE = actifs, FALSE = inactifs
    p_order_by VARCHAR DEFAULT 'createdat',    -- 'createdat', 'username', 'structure', 'login'
    p_order_dir VARCHAR DEFAULT 'DESC'
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSON;
    v_utilisateurs JSON;
    v_stats JSON;
    v_total INTEGER;
    v_pages INTEGER;
    v_search_pattern VARCHAR;
BEGIN
    -- Préparer le pattern de recherche
    v_search_pattern := CASE 
        WHEN p_search IS NOT NULL AND TRIM(p_search) != '' 
        THEN '%' || LOWER(TRIM(p_search)) || '%'
        ELSE NULL 
    END;

    -- ===== STATISTIQUES GLOBALES =====
    SELECT json_build_object(
        'total_utilisateurs', COUNT(*),
        'utilisateurs_actifs', COUNT(*) FILTER (WHERE u.actif = TRUE),
        'utilisateurs_inactifs', COUNT(*) FILTER (WHERE u.actif = FALSE OR u.actif IS NULL),
        'pwd_changed', COUNT(*) FILTER (WHERE u.pwd_changed = TRUE),
        'pwd_not_changed', COUNT(*) FILTER (WHERE u.pwd_changed = FALSE OR u.pwd_changed IS NULL),
        'par_groupe', (
            SELECT json_object_agg(
                COALESCE(grp.nom_groupe, 'Sans groupe'),
                grp.cnt
            )
            FROM (
                SELECT g.nom_groupe, COUNT(*) as cnt
                FROM utilisateur ut
                LEFT JOIN groupe g ON ut.id_groupe = g.id_groupe
                LEFT JOIN structures st ON ut.id_structure = st.id_structure
                WHERE st.actif = TRUE OR ut.id_structure <= 0
                GROUP BY g.nom_groupe
            ) grp
        ),
        'par_profil', (
            SELECT json_object_agg(
                COALESCE(prf.nom_profil, 'Sans profil'),
                prf.cnt
            )
            FROM (
                SELECT p.nom_profil, COUNT(*) as cnt
                FROM utilisateur ut
                JOIN profil p ON ut.id_profil = p.id_profil
                LEFT JOIN structures st ON ut.id_structure = st.id_structure
                WHERE st.actif = TRUE OR ut.id_structure <= 0
                GROUP BY p.nom_profil
            ) prf
        ),
        'par_structure', (
            SELECT json_agg(json_build_object(
                'id_structure', str.id_structure,
                'nom_structure', str.nom_structure,
                'count', str.cnt
            ) ORDER BY str.cnt DESC)
            FROM (
                SELECT s.id_structure, s.nom_structure, COUNT(*) as cnt
                FROM utilisateur ut
                JOIN structures s ON ut.id_structure = s.id_structure
                WHERE s.actif = TRUE
                GROUP BY s.id_structure, s.nom_structure
                ORDER BY cnt DESC
                LIMIT 10
            ) str
        ),
        'nouveaux_ce_mois', (
            SELECT COUNT(*) 
            FROM utilisateur ut
            LEFT JOIN structures st ON ut.id_structure = st.id_structure
            WHERE (st.actif = TRUE OR ut.id_structure <= 0)
            AND ut.createdat >= DATE_TRUNC('month', CURRENT_DATE)
        )
    ) INTO v_stats
    FROM utilisateur u
    LEFT JOIN structures s ON u.id_structure = s.id_structure
    WHERE s.actif = TRUE OR u.id_structure <= 0;  -- Inclure admin système

    -- ===== COMPTER LE TOTAL FILTRÉ =====
    SELECT COUNT(*) INTO v_total
    FROM utilisateur u
    LEFT JOIN groupe g ON u.id_groupe = g.id_groupe
    LEFT JOIN list_structures ls ON u.id_structure = ls.id_structure
    LEFT JOIN profil p ON p.id_profil = u.id_profil
    WHERE (ls.actif = TRUE OR u.id_structure <= 0)  -- Inclure admin système
    AND (
        v_search_pattern IS NULL 
        OR LOWER(u.username) LIKE v_search_pattern
        OR LOWER(u.login) LIKE v_search_pattern
        OR u.tel_user LIKE v_search_pattern
        OR LOWER(COALESCE(ls.nom_structure, '')) LIKE v_search_pattern
    )
    AND (p_id_structure IS NULL OR u.id_structure = p_id_structure)
    AND (p_id_groupe IS NULL OR u.id_groupe = p_id_groupe)
    AND (p_id_profil IS NULL OR u.id_profil = p_id_profil)
    AND (p_actif IS NULL OR u.actif = p_actif);

    -- Calculer le nombre de pages
    v_pages := CEIL(v_total::NUMERIC / GREATEST(p_limit, 1));

    -- ===== RÉCUPÉRER LES UTILISATEURS =====
    SELECT json_agg(user_row)
    INTO v_utilisateurs
    FROM (
        SELECT json_build_object(
            'id', u.id,
            'username', u.username,
            'login', u.login,
            'telephone', u.tel_user,
            'actif', COALESCE(u.actif, FALSE),
            'pwd_changed', COALESCE(u.pwd_changed, FALSE),
            'date_creation', u.createdat,
            'date_modification', u.updatedat,
            'groupe', json_build_object(
                'id_groupe', u.id_groupe,
                'nom_groupe', g.nom_groupe,
                'description', g.description
            ),
            'profil', json_build_object(
                'id_profil', u.id_profil,
                'nom_profil', p.nom_profil
            ),
            'structure', CASE 
                WHEN u.id_structure <= 0 THEN json_build_object(
                    'id_structure', u.id_structure,
                    'nom_structure', 'Système FayClick',
                    'type_structure', 'SYSTEME',
                    'actif', TRUE
                )
                ELSE json_build_object(
                    'id_structure', ls.id_structure,
                    'code_structure', ls.code_structure,
                    'nom_structure', ls.nom_structure,
                    'type_structure', ls.type_structure,
                    'adresse', ls.structure_adresse,
                    'mobile_om', ls.structure_mobile_om,
                    'mobile_wave', ls.structure_mobile_wave,
                    'email', ls.structure_email,
                    'logo', ls.logo,
                    'actif', ls.actif
                )
            END,
            'is_admin_system', (u.id_structure <= 0)
        ) AS user_row
        FROM utilisateur u
        LEFT JOIN groupe g ON u.id_groupe = g.id_groupe
        LEFT JOIN list_structures ls ON u.id_structure = ls.id_structure
        LEFT JOIN profil p ON p.id_profil = u.id_profil
        WHERE (ls.actif = TRUE OR u.id_structure <= 0)
        AND (
            v_search_pattern IS NULL 
            OR LOWER(u.username) LIKE v_search_pattern
            OR LOWER(u.login) LIKE v_search_pattern
            OR u.tel_user LIKE v_search_pattern
            OR LOWER(COALESCE(ls.nom_structure, '')) LIKE v_search_pattern
        )
        AND (p_id_structure IS NULL OR u.id_structure = p_id_structure)
        AND (p_id_groupe IS NULL OR u.id_groupe = p_id_groupe)
        AND (p_id_profil IS NULL OR u.id_profil = p_id_profil)
        AND (p_actif IS NULL OR u.actif = p_actif)
        ORDER BY 
            CASE WHEN p_order_by = 'createdat' AND p_order_dir = 'DESC' THEN u.createdat END DESC NULLS LAST,
            CASE WHEN p_order_by = 'createdat' AND p_order_dir = 'ASC' THEN u.createdat END ASC NULLS LAST,
            CASE WHEN p_order_by = 'username' AND p_order_dir = 'DESC' THEN u.username END DESC NULLS LAST,
            CASE WHEN p_order_by = 'username' AND p_order_dir = 'ASC' THEN u.username END ASC NULLS LAST,
            CASE WHEN p_order_by = 'login' AND p_order_dir = 'DESC' THEN u.login END DESC NULLS LAST,
            CASE WHEN p_order_by = 'login' AND p_order_dir = 'ASC' THEN u.login END ASC NULLS LAST,
            CASE WHEN p_order_by = 'structure' AND p_order_dir = 'DESC' THEN ls.nom_structure END DESC NULLS LAST,
            CASE WHEN p_order_by = 'structure' AND p_order_dir = 'ASC' THEN ls.nom_structure END ASC NULLS LAST,
            u.createdat DESC  -- Défaut
        LIMIT p_limit
        OFFSET p_offset
    ) sub;

    -- ===== CONSTRUIRE LE RÉSULTAT FINAL =====
    v_result := json_build_object(
        'success', true,
        'data', json_build_object(
            'utilisateurs', COALESCE(v_utilisateurs, '[]'::json),
            'stats', v_stats,
            'pagination', json_build_object(
                'total', v_total,
                'limit', p_limit,
                'offset', p_offset,
                'pages', v_pages,
                'current_page', FLOOR(p_offset / GREATEST(p_limit, 1)) + 1
            )
        ),
        'filtres_appliques', json_build_object(
            'search', p_search,
            'id_structure', p_id_structure,
            'id_groupe', p_id_groupe,
            'id_profil', p_id_profil,
            'actif', p_actif,
            'order_by', p_order_by,
            'order_dir', p_order_dir
        ),
        'generated_at', NOW()
    );

    RETURN v_result;

EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM,
            'error_code', SQLSTATE
        );
END;
$$;

COMMENT ON FUNCTION get_admin_all_utilisateurs(INTEGER, INTEGER, VARCHAR, INTEGER, INTEGER, INTEGER, BOOLEAN, VARCHAR, VARCHAR) IS 
'Liste complète des utilisateurs avec stats, pagination et filtres pour le dashboard admin FayClick';


-- ============================================================================
-- FONCTION: get_admin_detail_utilisateur()
-- Objectif: Détails complets d'un utilisateur spécifique
-- ============================================================================

CREATE OR REPLACE FUNCTION get_admin_detail_utilisateur(
    p_id_utilisateur INTEGER
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSON;
    v_utilisateur JSON;
    v_activite JSON;
    v_date_debut_mois DATE;
BEGIN
    -- Vérifier que l'utilisateur existe
    IF NOT EXISTS (SELECT 1 FROM utilisateur WHERE id = p_id_utilisateur) THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Utilisateur non trouvé',
            'error_code', 'NOT_FOUND'
        );
    END IF;

    v_date_debut_mois := DATE_TRUNC('month', CURRENT_DATE)::DATE;

    -- ===== INFORMATIONS UTILISATEUR =====
    SELECT json_build_object(
        'id', u.id,
        'username', u.username,
        'login', u.login,
        'telephone', u.tel_user,
        'actif', COALESCE(u.actif, FALSE),
        'pwd_changed', COALESCE(u.pwd_changed, FALSE),
        'date_creation', u.createdat,
        'date_modification', u.updatedat,
        'groupe', json_build_object(
            'id_groupe', u.id_groupe,
            'nom_groupe', g.nom_groupe,
            'description', g.description
        ),
        'profil', json_build_object(
            'id_profil', u.id_profil,
            'nom_profil', p.nom_profil
        ),
        'structure', CASE 
            WHEN u.id_structure <= 0 THEN json_build_object(
                'id_structure', u.id_structure,
                'nom_structure', 'Système FayClick',
                'type_structure', 'SYSTEME',
                'actif', TRUE
            )
            ELSE json_build_object(
                'id_structure', s.id_structure,
                'code_structure', s.code_structure,
                'nom_structure', s.nom_structure,
                'type_structure', ts.nom_type,
                'adresse', s.adresse,
                'mobile_om', s.mobile_om,
                'mobile_wave', s.mobile_wave,
                'email', s.email,
                'logo', s.logo,
                'actif', s.actif
            )
        END,
        'is_admin_system', (u.id_structure <= 0)
    ) INTO v_utilisateur
    FROM utilisateur u
    LEFT JOIN groupe g ON u.id_groupe = g.id_groupe
    LEFT JOIN structures s ON u.id_structure = s.id_structure
    LEFT JOIN type_structure ts ON s.id_type = ts.id_type
    LEFT JOIN profil p ON p.id_profil = u.id_profil
    WHERE u.id = p_id_utilisateur;

    -- ===== ACTIVITÉ DE L'UTILISATEUR (si structure > 0) =====
    SELECT json_build_object(
        'factures_total', COALESCE(COUNT(*), 0),
        'factures_mois', COALESCE(COUNT(*) FILTER (WHERE f.date_facture >= v_date_debut_mois), 0),
        'montant_total', COALESCE(SUM(f.montant), 0),
        'montant_mois', COALESCE(SUM(f.montant) FILTER (WHERE f.date_facture >= v_date_debut_mois), 0),
        'derniere_facture', MAX(f.date_facture),
        'premiere_facture', MIN(f.date_facture)
    ) INTO v_activite
    FROM facture_com f
    WHERE f.id_utilisateur = p_id_utilisateur;

    -- ===== CONSTRUIRE LE RÉSULTAT FINAL =====
    v_result := json_build_object(
        'success', true,
        'data', json_build_object(
            'utilisateur', v_utilisateur,
            'activite', v_activite
        )
    );

    RETURN v_result;

EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM,
            'error_code', SQLSTATE
        );
END;
$$;

COMMENT ON FUNCTION get_admin_detail_utilisateur(INTEGER) IS 
'Détails complets d''un utilisateur avec son activité';


-- ============================================================================
-- FONCTION: get_admin_reference_data()
-- Objectif: Récupérer les données de référence pour les filtres (groupes, profils, structures)
-- ============================================================================

CREATE OR REPLACE FUNCTION get_admin_reference_data()
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSON;
BEGIN
    SELECT json_build_object(
        'success', true,
        'data', json_build_object(
            'groupes', (
                SELECT json_agg(json_build_object(
                    'id_groupe', g.id_groupe,
                    'nom_groupe', g.nom_groupe,
                    'description', g.description
                ) ORDER BY g.nom_groupe)
                FROM groupe g
            ),
            'profils', (
                SELECT json_agg(json_build_object(
                    'id_profil', p.id_profil,
                    'nom_profil', p.nom_profil
                ) ORDER BY p.nom_profil)
                FROM profil p
            ),
            'structures', (
                SELECT json_agg(json_build_object(
                    'id_structure', s.id_structure,
                    'nom_structure', s.nom_structure,
                    'type_structure', t.nom_type,
                    'actif', s.actif
                ) ORDER BY s.nom_structure)
                FROM structures s
                JOIN type_structure t ON s.id_type = t.id_type
                WHERE s.actif = TRUE
            ),
            'types_structure', (
                SELECT json_agg(json_build_object(
                    'id_type', t.id_type,
                    'nom_type', t.nom_type
                ) ORDER BY t.nom_type)
                FROM type_structure t
            )
        )
    ) INTO v_result;

    RETURN v_result;

EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM,
            'error_code', SQLSTATE
        );
END;
$$;

COMMENT ON FUNCTION get_admin_reference_data() IS 
'Données de référence pour les filtres du dashboard admin (groupes, profils, structures)';


-- ============================================================================
-- INDEX RECOMMANDÉS
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_utilisateur_structure_actif 
ON utilisateur(id_structure, actif);

CREATE INDEX IF NOT EXISTS idx_utilisateur_groupe 
ON utilisateur(id_groupe);

CREATE INDEX IF NOT EXISTS idx_utilisateur_profil 
ON utilisateur(id_profil);

CREATE INDEX IF NOT EXISTS idx_utilisateur_login_lower 
ON utilisateur(LOWER(login));

CREATE INDEX IF NOT EXISTS idx_utilisateur_createdat 
ON utilisateur(createdat DESC);


-- ============================================================================
-- EXEMPLES D'UTILISATION
-- ============================================================================

/*
-- 1. Liste de tous les utilisateurs (page 1, 20 par page)
SELECT * FROM get_admin_all_utilisateurs();

-- 2. Rechercher un utilisateur
SELECT * FROM get_admin_all_utilisateurs(20, 0, 'mamadou');

-- 3. Filtrer par structure
SELECT * FROM get_admin_all_utilisateurs(20, 0, NULL, 183);

-- 4. Filtrer par groupe
SELECT * FROM get_admin_all_utilisateurs(20, 0, NULL, NULL, 1);

-- 5. Filtrer par profil
SELECT * FROM get_admin_all_utilisateurs(20, 0, NULL, NULL, NULL, 2);

-- 6. Uniquement les utilisateurs actifs
SELECT * FROM get_admin_all_utilisateurs(20, 0, NULL, NULL, NULL, NULL, TRUE);

-- 7. Trier par nom d'utilisateur
SELECT * FROM get_admin_all_utilisateurs(20, 0, NULL, NULL, NULL, NULL, NULL, 'username', 'ASC');

-- 8. Page 2 des résultats
SELECT * FROM get_admin_all_utilisateurs(20, 20);

-- 9. Détail d'un utilisateur spécifique
SELECT * FROM get_admin_detail_utilisateur(80);

-- 10. Données de référence pour les filtres
SELECT * FROM get_admin_reference_data();

-- 11. Extraire juste les stats
SELECT data->'stats' FROM get_admin_all_utilisateurs();

-- 12. Compter utilisateurs par groupe
SELECT data->'stats'->'par_groupe' FROM get_admin_all_utilisateurs();
*/
Résumé des fonctions créées
FonctionObjectifget_admin_all_utilisateurs()Liste paginée avec stats globales et filtresget_admin_detail_utilisateur()Détails complets d'un utilisateur + activitéget_admin_reference_data()Données de référence pour les dropdowns de filtres
Structure du résultat get_admin_all_utilisateurs()
json{
  "success": true,
  "data": {
    "utilisateurs": [
      {
        "id": 80,
        "username": "MAGUETE THIAM",
        "login": "boncoinminababelbazar",
        "telephone": "776512721",
        "actif": true,
        "pwd_changed": true,
        "groupe": {
          "id_groupe": 1,
          "nom_groupe": "Administrateur"
        },
        "profil": {
          "id_profil": 1,
          "nom_profil": "Super Admin"
        },
        "structure": {
          "id_structure": 89,
          "nom_structure": "Boncoin Minaba Belbazar",
          "type_structure": "COMMERCIALE"
        }
      }
    ],
    "stats": {
      "total_utilisateurs": 150,
      "utilisateurs_actifs": 142,
      "utilisateurs_inactifs": 8,
      "pwd_changed": 130,
      "pwd_not_changed": 20,
      "par_groupe": {
        "Administrateur": 50,
        "Vendeur": 80,
        "Caissier": 20
      },
      "par_profil": {...},
      "par_structure": [...],
      "nouveaux_ce_mois": 12
    },
    "pagination": {
      "total": 150,
      "limit": 20,
      "pages": 8,
      "current_page": 1
    }
  }
}
Paramètres de filtrage disponibles
ParamètreTypeDescriptionp_searchVARCHARRecherche sur username, login, téléphone, structurep_id_structureINTEGERFiltrer par structurep_id_groupeINTEGERFiltrer par groupep_id_profilINTEGERFiltrer par profilp_actifBOOLEANTRUE = actifs, FALSE = inactifs, NULL = tousp_order_byVARCHAR'createdat', 'username', 'login', 'structure'p_order_dirVARCHAR'ASC' ou 'DESC'