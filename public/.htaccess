# Configuration Apache pour FayClick V2
# Gestion des routes Next.js avec export statique

# SÉCURITÉ : Désactiver les listings de répertoire
Options -Indexes

# Activer le moteur de réécriture
RewriteEngine On

# IMPORTANT: Gestion des factures avec token
# Redirection des URLs /fay/XXX vers /facture?token=XXX
RewriteRule ^fay/(.+)$ /facture?token=$1 [L,QSA,R=301]

# Si on accède à /facture avec un token, servir facture.html
RewriteCond %{REQUEST_URI} ^/facture$
RewriteCond %{QUERY_STRING} token=([^&]+)
RewriteRule ^facture$ /facture.html [L,QSA]

# Rediriger /login vers /login.html si le fichier n'existe pas
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} ^/login/?$
RewriteRule ^(.*)$ /login.html [L]

# Rediriger /register vers /register.html si le fichier n'existe pas
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} ^/register/?$
RewriteRule ^(.*)$ /register.html [L]

# Rediriger autres routes statiques vers .html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/_next/
RewriteCond %{REQUEST_URI} !\.(css|js|png|jpg|ico|svg|json)$
RewriteRule ^([^/]+)/?$ /$1.html [L]

# Support pour dossiers avec index.html (2 niveaux)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/_next/
RewriteRule ^([^/]+)/([^/]+)/?$ /$1/$2.html [L]

# Support pour routes à 3 niveaux (/dashboard/commerce/)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/_next/
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/?$ /$1/$2/$3.html [L]

# Support pour routes à 4 niveaux et plus
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/_next/
RewriteRule ^(.+)/?$ /$1.html [L]

# Fallback : Si aucune route ne match, rediriger vers index.html (SPA fallback)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/_next/
RewriteCond %{REQUEST_URI} !\.(css|js|png|jpg|ico|svg|json|woff|woff2|ttf|eot)$
RewriteRule ^.*$ /index.html [L]

# Page 404 personnalisée
ErrorDocument 404 /404.html